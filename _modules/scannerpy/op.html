
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>scannerpy.op &#8212; Scanner 0.0.1 documentation</title>
    <link rel="stylesheet" href="../../_static/readable.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
    <script type="text/javascript" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head><body>
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Scanner 0.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for scannerpy.op</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">grpc</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">types</span>

<span class="kn">from</span> <span class="nn">scannerpy.common</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">scannerpy.protobuf_generator</span> <span class="k">import</span> <span class="n">python_to_proto</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="k">import</span> <span class="n">signature</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">islice</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">wraps</span>


<div class="viewcode-block" id="OpColumn"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.OpColumn">[docs]</a><span class="k">class</span> <span class="nc">OpColumn</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">typ</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="n">op</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_col</span> <span class="o">=</span> <span class="n">col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">typ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_encode_options</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">Video</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_encode_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;codec&#39;</span><span class="p">:</span> <span class="s1">&#39;default&#39;</span><span class="p">}</span>

<div class="viewcode-block" id="OpColumn.compress"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.OpColumn.compress">[docs]</a>    <span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">codec</span><span class="o">=</span><span class="s1">&#39;video&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_is_video</span><span class="p">()</span>
        <span class="n">codecs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;video&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress_video</span><span class="p">,</span>
            <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress_default</span><span class="p">,</span>
            <span class="s1">&#39;raw&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lossless</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">codec</span> <span class="ow">in</span> <span class="n">codecs</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">codecs</span><span class="p">[</span><span class="n">codec</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span><span class="s1">&#39;Compression codec </span><span class="si">{}</span><span class="s1"> not currently &#39;</span>
                                   <span class="s1">&#39;supported. Available codecs are: </span><span class="si">{}</span><span class="s1">.&#39;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">codecs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))))</span></div>

<div class="viewcode-block" id="OpColumn.compress_video"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.OpColumn.compress_video">[docs]</a>    <span class="k">def</span> <span class="nf">compress_video</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quality</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">bitrate</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keyframe_distance</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_is_video</span><span class="p">()</span>
        <span class="n">encode_options</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;codec&#39;</span><span class="p">:</span> <span class="s1">&#39;h264&#39;</span><span class="p">,</span>
            <span class="s1">&#39;quality&#39;</span><span class="p">:</span> <span class="n">quality</span><span class="p">,</span>
            <span class="s1">&#39;bitrate&#39;</span><span class="p">:</span> <span class="n">bitrate</span><span class="p">,</span>
            <span class="s1">&#39;keyframe_distance&#39;</span><span class="p">:</span> <span class="n">keyframe_distance</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_compressed_column</span><span class="p">(</span><span class="n">encode_options</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpColumn.lossless"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.OpColumn.lossless">[docs]</a>    <span class="k">def</span> <span class="nf">lossless</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_is_video</span><span class="p">()</span>
        <span class="n">encode_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;codec&#39;</span><span class="p">:</span> <span class="s1">&#39;raw&#39;</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_compressed_column</span><span class="p">(</span><span class="n">encode_options</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpColumn.compress_default"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.OpColumn.compress_default">[docs]</a>    <span class="k">def</span> <span class="nf">compress_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_is_video</span><span class="p">()</span>
        <span class="n">encode_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;codec&#39;</span><span class="p">:</span> <span class="s1">&#39;default&#39;</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_compressed_column</span><span class="p">(</span><span class="n">encode_options</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_assert_is_video</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">Video</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span><span class="s1">&#39;Compression only supported for columns of&#39;</span>
                                   <span class="s1">&#39;type &quot;video&quot;. Column </span><span class="si">{}</span><span class="s1"> type is </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_col</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">ColumnType</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">_type</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_new_compressed_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encode_options</span><span class="p">):</span>
        <span class="n">new_col</span> <span class="o">=</span> <span class="n">OpColumn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span><span class="p">)</span>
        <span class="n">new_col</span><span class="o">.</span><span class="n">_encode_options</span> <span class="o">=</span> <span class="n">encode_options</span>
        <span class="k">return</span> <span class="n">new_col</span></div>


<span class="n">PYTHON_OP_REGISTRY</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="OpGenerator"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.OpGenerator">[docs]</a><span class="k">class</span> <span class="nc">OpGenerator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates Op instances to define a computation.</span>

<span class="sd">    When a particular op is requested from the generator, e.g.</span>
<span class="sd">    `db.ops.Histogram`, the generator does a dynamic lookup for the</span>
<span class="sd">    op in a C++ registry.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">db</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="c1"># Check python registry for Op</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">PYTHON_OP_REGISTRY</span><span class="p">:</span>
            <span class="n">py_op_info</span> <span class="o">=</span> <span class="n">PYTHON_OP_REGISTRY</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="c1"># If Op has not been registered yet, register it</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">_python_ops</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">register_op</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;input_columns&#39;</span><span class="p">],</span>
                    <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;output_columns&#39;</span><span class="p">],</span> <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;variadic_inputs&#39;</span><span class="p">],</span>
                    <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;stencil&#39;</span><span class="p">],</span> <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;unbounded_state&#39;</span><span class="p">],</span>
                    <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;bounded_state&#39;</span><span class="p">],</span> <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;proto_path&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">register_python_kernel</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;device_type&#39;</span><span class="p">],</span>
                                                <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;kernel&#39;</span><span class="p">],</span>
                                                <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">])</span>

        <span class="c1"># This will raise an exception if the op does not exist.</span>
        <span class="n">op_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">_get_op_info</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">make_op</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">op_info</span><span class="o">.</span><span class="n">variadic_inputs</span><span class="p">:</span>
                <span class="n">inputs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">op_info</span><span class="o">.</span><span class="n">input_columns</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                            <span class="s1">&#39;Op </span><span class="si">{}</span><span class="s1"> required column </span><span class="si">{}</span><span class="s1"> as input&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="n">inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="n">device</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;device&#39;</span><span class="p">,</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">CPU</span><span class="p">)</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">bounded_state</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;bounded_state&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">stencil</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;stencil&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">extra</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;extra&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;args&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">op</span> <span class="o">=</span> <span class="n">Op</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">bounded_state</span><span class="p">,</span>
                    <span class="n">stencil</span><span class="p">,</span> <span class="n">kwargs</span> <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">args</span><span class="p">,</span> <span class="n">extra</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">outputs</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">make_op</span></div>


<div class="viewcode-block" id="Op"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.Op">[docs]</a><span class="k">class</span> <span class="nc">Op</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">db</span><span class="p">,</span>
                 <span class="n">name</span><span class="p">,</span>
                 <span class="n">inputs</span><span class="p">,</span>
                 <span class="n">device</span><span class="p">,</span>
                 <span class="n">batch</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">warmup</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">stencil</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                 <span class="n">args</span><span class="o">=</span><span class="p">{},</span>
                 <span class="n">extra</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inputs</span> <span class="o">=</span> <span class="n">inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batch</span> <span class="o">=</span> <span class="n">batch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_warmup</span> <span class="o">=</span> <span class="n">warmup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stencil</span> <span class="o">=</span> <span class="n">stencil</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extra</span> <span class="o">=</span> <span class="n">extra</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Space&#39;</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Sample&#39;</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Slice&#39;</span>
                <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Unslice&#39;</span><span class="p">):</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
                <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OpColumn</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">_col</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">_type</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">_get_output_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">OpColumn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">type</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span> <span class="o">=</span> <span class="n">outputs</span>

<div class="viewcode-block" id="Op.inputs"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.Op.inputs">[docs]</a>    <span class="k">def</span> <span class="nf">inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputs</span></div>

<div class="viewcode-block" id="Op.outputs"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.Op.outputs">[docs]</a>    <span class="k">def</span> <span class="nf">outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Op.to_proto"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.Op.to_proto">[docs]</a>    <span class="k">def</span> <span class="nf">to_proto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
        <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">Op</span><span class="p">()</span>
        <span class="n">e</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
        <span class="n">e</span><span class="o">.</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">to_proto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">protobufs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="p">)</span>
        <span class="n">e</span><span class="o">.</span><span class="n">stencil</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stencil</span><span class="p">)</span>
        <span class="n">e</span><span class="o">.</span><span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch</span>
        <span class="n">e</span><span class="o">.</span><span class="n">warmup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warmup</span>

        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;Input&quot;</span><span class="p">:</span>
            <span class="n">inp</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
            <span class="n">inp</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_col</span>
            <span class="n">inp</span><span class="o">.</span><span class="n">op_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputs</span><span class="p">:</span>
                <span class="n">inp</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">_op</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">_op</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">inp</span><span class="o">.</span><span class="n">op_index</span> <span class="o">=</span> <span class="n">idx</span>
                <span class="n">inp</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">_col</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">_python_ops</span><span class="p">:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">kernel_args</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># To convert an arguments dict, we search for a protobuf with the</span>
                <span class="c1"># name {Op}Args (e.g. BlurArgs, HistogramArgs) in the</span>
                <span class="c1"># args.proto module, and fill that in with keys from the args dict.</span>
                <span class="n">op_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">_get_op_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">op_info</span><span class="o">.</span><span class="n">protobuf_name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">proto_name</span> <span class="o">=</span> <span class="n">op_info</span><span class="o">.</span><span class="n">protobuf_name</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">kernel_args</span> <span class="o">=</span> <span class="n">python_to_proto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">protobufs</span><span class="p">,</span>
                                                    <span class="n">proto_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">kernel_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If arguments are a protobuf object, serialize it directly</span>
            <span class="n">e</span><span class="o">.</span><span class="n">kernel_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">e</span></div></div>


<div class="viewcode-block" id="register_python_op"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.register_python_op">[docs]</a><span class="k">def</span> <span class="nf">register_python_op</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">stencil</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">unbounded_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">bounded_state</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">device_type</span><span class="p">:</span> <span class="n">DeviceType</span> <span class="o">=</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">CPU</span><span class="p">,</span>
                       <span class="n">batch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                       <span class="n">proto_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">dec</span><span class="p">(</span><span class="n">fn_or_class</span><span class="p">):</span>
        <span class="n">is_fn</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fn_or_class</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">fn_or_class</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">BuiltinFunctionType</span><span class="p">):</span>
            <span class="n">is_fn</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Infer name from fn_or_class name</span>
            <span class="n">kname</span> <span class="o">=</span> <span class="n">fn_or_class</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kname</span> <span class="o">=</span> <span class="n">name</span>

        <span class="n">can_stencil</span> <span class="o">=</span> <span class="n">stencil</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">can_batch</span> <span class="o">=</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">1</span>

        <span class="c1"># Get execute function to determine input and output types</span>
        <span class="k">if</span> <span class="n">is_fn</span><span class="p">:</span>
            <span class="n">exec_fn</span> <span class="o">=</span> <span class="n">fn_or_class</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exec_fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fn_or_class</span><span class="p">,</span> <span class="s2">&quot;execute&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">exec_fn</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                    <span class="p">(</span><span class="s1">&#39;Attempted to register Python Op with name </span><span class="si">{:s}</span><span class="s1">, but that &#39;</span>
                     <span class="s1">&#39;provided class has no &quot;execute&quot; method.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kname</span><span class="p">))</span>

        <span class="n">input_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">has_variadic_inputs</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">signature</span><span class="p">(</span><span class="n">exec_fn</span><span class="p">)</span>

        <span class="n">fn_params</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span>
        <span class="k">if</span> <span class="n">is_fn</span><span class="p">:</span>
            <span class="c1"># If this is a fn kernel, then the first argument should be `config`</span>
            <span class="n">fn_params</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">fn_params</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If this is a class kernel, then first argument should be self</span>
            <span class="n">fn_params</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">fn_params</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">parse_annotation_to_column_type</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">is_input</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">can_batch</span><span class="p">:</span>
                <span class="c1"># If the op can batch, then we expect the types to be</span>
                <span class="c1"># Sequence[T], where T = {bytes, FrameType}</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="s1">&#39;__origin__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="ow">or</span> <span class="n">typ</span><span class="o">.</span><span class="n">__origin__</span> <span class="o">!=</span> <span class="n">Sequence</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                        <span class="p">(</span><span class="s1">&#39;A batched Op must specify a &quot;Sequence&quot; type &#39;</span>
                         <span class="s1">&#39;annotation for each input and output.&#39;</span><span class="p">))</span>
                <span class="n">typ</span> <span class="o">=</span> <span class="n">typ</span><span class="o">.</span><span class="n">__args__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">is_input</span> <span class="ow">and</span> <span class="n">can_stencil</span><span class="p">:</span>
                <span class="c1"># If the op can stencil, then we expect the input types to be</span>
                <span class="c1"># Sequence[T], where T = {bytes, FrameType}</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="s1">&#39;__origin__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="ow">or</span> <span class="n">typ</span><span class="o">.</span><span class="n">__origin__</span> <span class="o">!=</span> <span class="n">Sequence</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                        <span class="p">(</span><span class="s1">&#39;A stenciled Op must specify a &quot;Sequence&quot; type &#39;</span>
                         <span class="s1">&#39;annotation for each input. If the Op both stencils &#39;</span>
                         <span class="s1">&#39;and batches, then it should have the type &#39;</span>
                         <span class="s1">&#39;&quot;Sequence[Sequence[T]], where T = {bytes, FrameType}.&#39;</span>
                         <span class="p">))</span>
                <span class="n">typ</span> <span class="o">=</span> <span class="n">typ</span><span class="o">.</span><span class="n">__args__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                    <span class="p">(</span><span class="s1">&#39;No type annotation specified for input </span><span class="si">{:s}</span><span class="s1">. Must &#39;</span>
                     <span class="s1">&#39;specify an annotation of &quot;bytes&quot; or &quot;FrameType&quot;.&#39;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param_name</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="nb">bytes</span><span class="p">:</span>
                <span class="n">column_type</span> <span class="o">=</span> <span class="n">ColumnType</span><span class="o">.</span><span class="n">Blob</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="n">FrameType</span><span class="p">:</span>
                <span class="n">column_type</span> <span class="o">=</span> <span class="n">ColumnType</span><span class="o">.</span><span class="n">Video</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                    <span class="p">(</span><span class="s1">&#39;Invalid type annotation specified for input </span><span class="si">{:s}</span><span class="s1">. Must &#39;</span>
                     <span class="s1">&#39;specify an annotation of type &quot;bytes&quot; or &#39;</span>
                     <span class="s1">&#39;&quot;FrameType&quot;.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param_name</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">column_type</span>

        <span class="c1"># Analyze exec_fn parameters to determine the input types</span>
        <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">fn_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># We only allow keyword arguments and *args.</span>
            <span class="c1"># There is no support currently for positional or **kwargs</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">kind</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">kind</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">POSITIONAL_ONLY</span> <span class="ow">or</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">VAR_KEYWORD</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                    <span class="p">(</span><span class="s1">&#39;Positional arguments and **kwargs are currently not &#39;</span>
                     <span class="s1">&#39;supported for the &quot;execute&quot; method of kernels&#39;</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">VAR_POSITIONAL</span><span class="p">:</span>
                <span class="c1"># This means we have variadic inputs</span>
                <span class="n">has_variadic_inputs</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fn_params</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                        <span class="p">(</span><span class="s1">&#39;Variadic positional inputs (*args) are not supported &#39;</span>
                         <span class="s1">&#39;when used with other inputs.&#39;</span><span class="p">))</span>
                <span class="k">break</span>

            <span class="n">typ</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span>
            <span class="n">column_type</span> <span class="o">=</span> <span class="n">parse_annotation_to_column_type</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">is_input</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">input_columns</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">param_name</span><span class="p">,</span> <span class="n">column_type</span><span class="p">))</span>

        <span class="n">output_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Analyze exec_fn return type to determine output types</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">return_annotation</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="n">sig</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                <span class="p">(</span><span class="s1">&#39;Return annotation must be specified for &quot;execute&quot; method.&#39;</span><span class="p">))</span>

        <span class="n">return_is_tuple</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="s1">&#39;__origin__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">Tuple</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="s1">&#39;__tuple_params__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="c1"># Python 3.5</span>
                <span class="n">use_ellipsis</span> <span class="o">=</span> <span class="n">typ</span><span class="o">.</span><span class="n">__tuple_use_ellipsis__</span>
                <span class="n">tuple_params</span> <span class="o">=</span> <span class="n">typ</span><span class="o">.</span><span class="n">__tuple_params__</span>
            <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="s1">&#39;__args__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="c1"># Python 3.6+</span>
                <span class="n">use_ellipsis</span> <span class="o">=</span> <span class="n">typ</span><span class="o">.</span><span class="n">__args__</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">Ellipsis</span>
                <span class="n">tuple_params</span> <span class="o">=</span> <span class="n">typ</span><span class="o">.</span><span class="n">__args__</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">use_ellipsis</span> <span class="k">else</span> <span class="kc">None</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span><span class="s1">&#39;This should not happen...&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">use_ellipsis</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">return_is_tuple</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">tuple_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">typ</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">use_ellipsis</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                <span class="p">(</span><span class="s1">&#39;Ellipsis tuples not supported for return type.&#39;</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">typ</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tuple_params</span><span class="p">):</span>
            <span class="n">column_type</span> <span class="o">=</span> <span class="n">parse_annotation_to_column_type</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>
            <span class="n">output_columns</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;ret</span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">column_type</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">kname</span> <span class="ow">in</span> <span class="n">PYTHON_OP_REGISTRY</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                <span class="s1">&#39;Attempted to register Op with name </span><span class="si">{:s}</span><span class="s1"> twice&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kname</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">parse_ret</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">return_is_tuple</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">r</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="p">)</span>

        <span class="c1"># Wrap exec_fn to destructure input and outputs to proper python inputs</span>
        <span class="k">if</span> <span class="n">is_fn</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">has_variadic_inputs</span><span class="p">:</span>

                <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn_or_class</span><span class="p">)</span>
                <span class="k">def</span> <span class="nf">wrapper_exec</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">in_cols</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">parse_ret</span><span class="p">(</span><span class="n">exec_fn</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">in_cols</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn_or_class</span><span class="p">)</span>
                <span class="k">def</span> <span class="nf">wrapper_exec</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">in_cols</span><span class="p">):</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="n">_</span><span class="p">),</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">input_columns</span><span class="p">,</span> <span class="n">in_cols</span><span class="p">):</span>
                        <span class="n">args</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
                    <span class="k">return</span> <span class="n">parse_ret</span><span class="p">(</span><span class="n">exec_fn</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">))</span>

            <span class="n">fn_or_class</span> <span class="o">=</span> <span class="n">wrapper_exec</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">has_variadic_inputs</span><span class="p">:</span>

                <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_cols</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">parse_ret</span><span class="p">(</span><span class="n">exec_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">in_cols</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_cols</span><span class="p">):</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="n">_</span><span class="p">),</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">input_columns</span><span class="p">,</span> <span class="n">in_cols</span><span class="p">):</span>
                        <span class="n">args</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
                    <span class="k">return</span> <span class="n">parse_ret</span><span class="p">(</span><span class="n">exec_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">))</span>

            <span class="n">fn_or_class</span><span class="o">.</span><span class="n">execute</span> <span class="o">=</span> <span class="n">execute</span>

        <span class="n">PYTHON_OP_REGISTRY</span><span class="p">[</span><span class="n">kname</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;input_columns&#39;</span><span class="p">:</span> <span class="n">input_columns</span><span class="p">,</span>
            <span class="s1">&#39;output_columns&#39;</span><span class="p">:</span> <span class="n">output_columns</span><span class="p">,</span>
            <span class="s1">&#39;variadic_inputs&#39;</span><span class="p">:</span> <span class="n">has_variadic_inputs</span><span class="p">,</span>
            <span class="s1">&#39;stencil&#39;</span><span class="p">:</span> <span class="n">stencil</span><span class="p">,</span>
            <span class="s1">&#39;unbounded_state&#39;</span><span class="p">:</span> <span class="n">unbounded_state</span><span class="p">,</span>
            <span class="s1">&#39;bounded_state&#39;</span><span class="p">:</span> <span class="n">bounded_state</span><span class="p">,</span>
            <span class="s1">&#39;kernel&#39;</span><span class="p">:</span> <span class="n">fn_or_class</span><span class="p">,</span>
            <span class="s1">&#39;device_type&#39;</span><span class="p">:</span> <span class="n">device_type</span><span class="p">,</span>
            <span class="s1">&#39;batch&#39;</span><span class="p">:</span> <span class="n">batch</span><span class="p">,</span>
            <span class="s1">&#39;proto_path&#39;</span><span class="p">:</span> <span class="n">proto_path</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">fn_or_class</span>

    <span class="k">return</span> <span class="n">dec</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><!-- Copyright (c) 2018 Jeff Forcier.

     Based on original work copyright (c) 2011 Kenneth Reitz and copyright (c) 2010
     Armin Ronacher.

     Some rights reserved.

     Redistribution and use in source and binary forms of the theme, with or
     without modification, are permitted provided that the following conditions
     are met:

     * Redistributions of source code must retain the above copyright
     notice, this list of conditions and the following disclaimer.

     * Redistributions in binary form must reproduce the above
     copyright notice, this list of conditions and the following
     disclaimer in the documentation and/or other materials provided
     with the distribution.

     * The names of the contributors may not be used to endorse or
     promote products derived from this software without specific
     prior written permission.

     THIS THEME IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
     AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
     IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
     ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
     LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
     CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
     SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
     INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
     CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
     ARISING IN ANY WAY OUT OF THE USE OF THIS THEME, EVEN IF ADVISED OF THE
     POSSIBILITY OF SUCH DAMAGE.
   -->

<h1 class="logo"><a href="../../index.html">Scanner</a></h1>



<p class="blurb">Efficient Video Analysis at Scale</p>




<p style="margin-bottom: 0px">
<a href="https://github.com/scanner-research/scanner" class="gh-btn" target="_blank" style="margin-bottom: 5px; display: inline-block;"> <span class="gh-text">View on GitHub</span> </a>
<iframe src="https://ghbtns.com/github-btn.html?user=scanner-research&repo=scanner&type=star&count=true&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="170px" height="20px"></iframe>
</p>



<p style="padding-bottom: 1px; margin-top: 0px; margin-bottom: 20px;">
</p><!-- Copyright (c) 2018 Jeff Forcier.

     Based on original work copyright (c) 2011 Kenneth Reitz and copyright (c) 2010
     Armin Ronacher.

     Some rights reserved.

     Redistribution and use in source and binary forms of the theme, with or
     without modification, are permitted provided that the following conditions
     are met:

     * Redistributions of source code must retain the above copyright
     notice, this list of conditions and the following disclaimer.

     * Redistributions in binary form must reproduce the above
     copyright notice, this list of conditions and the following
     disclaimer in the documentation and/or other materials provided
     with the distribution.

     * The names of the contributors may not be used to endorse or
     promote products derived from this software without specific
     prior written permission.

     THIS THEME IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
     AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
     IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
     ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
     LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
     CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
     SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
     INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
     CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
     ARISING IN ANY WAY OUT OF THE USE OF THIS THEME, EVEN IF ADVISED OF THE
     POSSIBILITY OF SUCH DAMAGE.
   -->
<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../programming-handbook.html">Programming Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">Citation &amp; About</a></li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation index</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer">
    &copy; Copyright 2018, Alex Poms, Will Crichton.
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.4.
  </div>
  
  </body>
</html>